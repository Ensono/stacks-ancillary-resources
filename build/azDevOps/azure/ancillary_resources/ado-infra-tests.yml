name: infrastructure-tests

# Include necessary variables for this pipeline file
variables:
  - template: azdo-pipeline-vars.yml
  - group: ensono-sp-creds

stages:

  - stage: infrastructure_tests

    jobs:

      - job: terraform_state
        displayName: Terraform State
        pool:
          vmImage: $(pool_vm_image)

        steps:
          - template: ../templates/setup.yml
            parameters:
              TaskctlVersion: ${{ variables.TaskctlVersion }}
              StacksEnvfileVersion: ${{ variables.StacksEnvfileVersion }}

          - template: ../templates/infra-tests.yml
            parameters:
              CHEF_LICENSE: $(CHEF_LICENSE)
              TESTS_PATH: /app/src/terraform_state/tests/$(CLOUD_PLATFORM)
              INSPEC_ARGS: "--input resource_group_name=$(resource_group_name) storage_account_name=$(storage_account_name) region=$(location)"

          - task: PublishTestResults@2
            inputs:
              testResultsFormat: JUnit
              testResultsFiles: outputs/tests/*.xml